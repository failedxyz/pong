<html>
	<head>
		<title>Pong</title>
		<link href='https://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
		<script type="text/javascript" src="/js/gun.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.4.3/phaser.min.js"></script>
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<style>
			body * {
				font-family: "Audiowide", sans-serif;
			}
			body {
				background: #000;
				margin: 0;
				padding: 0;
			}
			canvas {
				display: block;
				margin-left: auto;
				margin-right: auto;
			}
			#debug {
				background-color: #FFF;
				padding: 30px;
				margin: 15px;
				position: fixed;
				bottom: 15px;
				left: 15px;
			}
			#gameOver {
				display: none;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				position: absolute;
			}
		</style>
	</head>
	<body>
		<div id="debug">
			<div id="paddle">Ready.</div>
			<ul id="users"></ul>
		</div>
		<div id="gameOver">
			YOU LOSE
		</div>
		<script type="text/javascript">
			localStorage.clear();
			var gameOver = function() {
				$("#gameOver").fadeIn("fast");
				users.put((function() { var obj = {}; obj[username] = null; return obj; })());
			};

			var username = location.hash.slice(1);
			if (username.length == 0) username = "Guest" + (Math.floor(Math.random() * 9000) + 1000);

			var Gun = Gun || { };
			var gun = Gun(location.origin + "/gun");

			var pong = gun.get("pong").set();

			var users = pong.path("users").set();
			var isMyTurn = false;

			var db = { };
			db.pong = gun.get("pong").set();
			db.paddle = gun.get("paddle").set();

			var existing_users = [ ];

			users.map(function(_user, _username) {
				var el;
				el = document.getElementById("u_" + _username);
				if (el == null) {
					existing_users.push(_username);
					existing_users.sort();
					el = document.createElement("li");
					el.id = "u_" + _username;
					document.getElementById("users").appendChild(el);
				}
				el.innerHTML = _username + (_user.score ? ": " + _user["score"] : "");
			});

			var obj = {};
			obj[username] = { score: 0 };
			users.put(obj);

			determineTurn();

			var game = new Phaser.Game(1000, 700, Phaser.AUTO, '', {
				preload: preload, 
				create: create, 
				update: update, 
				render: render
			});
			var ring;
			var paddle = {
				angle: 0,
				width: 0.2 * Math.PI
			};

			db.paddle.on(function(value) {
				determineTurn();
				if (value.rotation) {
					if (!isMyTurn)
						paddle.body.rotation = value.rotation;
					$("#paddle").html("theta: " + value.rotation);
				}
			});

			function determineTurn() {
				db.paddle.val(function(value) {
					if (value.lock && value.lock.length > 0) {
						isMyTurn = value.lock === username;
						if (isMyTurn) {
							paddle.alpha = 1;
							try {
								document.getElementById("u_" + username).style.fontWeight = "bold";
							} catch (e) {}
						} else {
							paddle.alpha = 0.2;
							try {
								document.getElementById("u_" + username).style.fontWeight = "normal";
							} catch (e) {}
						}
					} else {
						db.paddle.put({
							"lock": username,
							"rotation": 0,
						});
					}
				});
			}

			var ball = {
				x: 0, 
				y: 0, 
				radius: 15, 
				velocity: 100, 
				angle: Math.random() * Math.PI * 2 
			};
			var offset = 10;
			var cursors;
			function preload() {
				//game.load.image("background", "assets/background.jpg");
				game.load.image("circle", "assets/ball.png");
				game.load.image("paddle", "assets/paddle.png");
				game.load.image("ring", "assets/ring.png");
				game.load.physics('sprites', 'assets/sprites.json');
			}
			function create() {
				game.physics.startSystem(Phaser.Physics.P2JS);
				game.physics.p2.defaultRestitution = 0;

				ring = game.add.sprite(game.world.centerX, game.world.centerY, 'ring');
				paddle = game.add.sprite(game.world.centerX, game.world.centerY, 'paddle');

				ball.graphics = game.add.sprite(game.world.centerX, game.world.centerY, "circle");
				ball.graphics.scale.setTo(0.75, 0.75);

				cursors = game.input.keyboard.createCursorKeys();

				game.physics.p2.enable([paddle, ball.graphics, ring]);

				paddle.body.clearShapes();
				ball.graphics.body.clearShapes();
				ring.body.clearShapes();
				paddle.body.loadPolygon('sprites', 'paddle');
				ball.graphics.body.loadPolygon('sprites', 'ball');
				ring.body.loadPolygon('sprites', 'ring');
				ball.graphics.body.velocity.y = -150;

				ball.graphics.body.onBeginContact.add(handleContact, this);

				function handleContact(body, contactBody, shapeFromBody, shapeContactBody, contactEquation ){
					determineTurn();
					if(body.sprite.key === "ring") {
						console.log("A");
						if (isMyTurn) gameOver();
						console.log("B");
						// Player did miss it, as it hit the ring!
						ball.graphics.body.x = game.world.centerX;
						ball.graphics.body.y = game.world.centerY;
						ball.graphics.body.velocity.x = 0;
						ball.graphics.body.velocity.y = 0;
						setTimeout(function() {
							ball.graphics.body.velocity.y = -150;
						}, 2000);
					} else {
						ball.graphics.body.velocity.x = ball.graphics.body.velocity.x * -1.05;
						ball.graphics.body.velocity.y = ball.graphics.body.velocity.y * -1.05;
						if (isMyTurn) {
							db.paddle.put({
								lock: existing_users.sort()[(existing_users.indexOf(username) + 1)] || existing_users[0],
								rotation: paddle.body.rotation,
								ballx: ball.graphics.body.x,
								bally: ball.graphics.body.y,
								ballvx: ball.graphics.body.velocity.x,
								ballvy: ball.graphics.body.velocity.y
							});
							determineTurn();
						} else {
						}
					}
				}

				paddle.body.static = true;
				ring.body.static = true;
			}
			function update() {
				if(isMyTurn) {
					var changed = false;
					if (cursors.right.isDown) {
						paddle.body.rotateRight(60);
						changed = true;
					} else if (cursors.left.isDown) {
						paddle.body.rotateLeft(60);
						changed = true;
					} else {
						paddle.body.rotateLeft(0)
					}
				} else {
					paddle.body.rotateLeft(0);
					paddle.body.rotateRight(0);
				}
			}

			function collisionHandler (obj1, obj2) {
				game.stage.backgroundColor = '#992d2d';
			}

			function render() {
				// game.debug.spriteInfo(ball.graphics, 32, 32);
				game.debug.body(paddle);
				game.debug.body(ball.graphics);
			}

			$(window).unload(function() {
				confirm("TEST");
				users.put((function() { var obj = {}; obj[username] = null; return obj; })());
			});

			document.body.onkeydown = function() {
				// console.log(paddle.body.rotation);
				if (isMyTurn) {
					db.paddle.put({
						lock: username,
						rotation: paddle.body.rotation,
					});
				}
			}
		</script>
	</body>
</html>